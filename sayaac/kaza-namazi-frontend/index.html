<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaza Namazı Sayacı</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 18px 16px; background: #111; color: #fff; }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }
    main { max-width: 720px; margin: 0 auto; padding: 14px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card {
      background: #fff; border-radius: 14px; padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .title { font-size: 16px; font-weight: 750; margin: 0; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button {
      appearance: none; border: 0; border-radius: 12px; padding: 12px 10px;
      font-weight: 750; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.10);
    }
    .inc { background: #2f7dff; color: #fff; }
    .dec { background: #e9eefc; color: #111; }
    .valueBox {
      margin-top: 10px; display: flex; justify-content: center; align-items: center;
      padding: 12px; border-radius: 12px; background: #f2f4f8;
      font-size: 28px; font-weight: 900; letter-spacing: .5px;
    }
    .meta { margin-top: 8px; font-size: 12px; opacity: .75; display: flex; justify-content: space-between; }
    .status { font-size: 12px; opacity: .85; }
    .warn { color: #b00020; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Kaza Namazı Sayacı</h1>
  </header>

  <main>
    <div class="grid" id="grid"></div>
    <p class="status" id="globalStatus"></p>
  </main>

  <script>
    // === BACKEND API ===
    const API_ROOT = "https://kaza-namazi-backend.onrender.com";

    const FEEDS = [
      { key: "sabah", label: "Sabah Namazı" },
      { key: "oglen", label: "Öğle Namazı" },
      { key: "ikindi", label: "İkindi Namazı" },
      { key: "aksam", label: "Akşam Namazı" },
      { key: "yatsi", label: "Yatsı Namazı" }
    ];

    const grid = document.getElementById("grid");
    const globalStatus = document.getElementById("globalStatus");

    const state = Object.fromEntries(FEEDS.map(f => [f.key, { value: 0, lastUpdated: "-" }]));

    function setGlobalStatus(msg, isWarn=false) {
      globalStatus.textContent = msg || "";
      globalStatus.className = "status" + (isWarn ? " warn" : "");
    }

    function cardTemplate(feed) {
      const id = feed.key;
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <p class="title">${feed.label}</p>
          <span class="status" id="status-${id}">Yükleniyor…</span>
        </div>

        <div class="controls">
          <button class="inc" id="inc-${id}">Arttır</button>
          <button class="dec" id="dec-${id}">Azalt</button>
        </div>

        <div class="valueBox" id="val-${id}">0</div>

        <div class="meta">
          <span>Feed: <b>${feed.key}</b></span>
          <span id="upd-${id}">-</span>
        </div>
      `;
      return card;
    }

    function setCardStatus(id, msg) {
      const el = document.getElementById(`status-${id}`);
      if (el) el.textContent = msg;
    }

    function renderValue(id) {
      document.getElementById(`val-${id}`).textContent = String(state[id].value);
      document.getElementById(`upd-${id}`).textContent = state[id].lastUpdated || "-";
    }

    function nowTR() {
      const d = new Date();
      return d.toLocaleString("tr-TR", { hour12: false });
    }

    async function fetchLastValue(feedKey) {
      const res = await fetch(`${API_ROOT}/api/feeds/${feedKey}`);
      if (!res.ok) throw new Error("Okuma hatası");
      const data = await res.json();
      return data.last_value ?? 0;
    }

    async function pushValue(feedKey, value) {
      const res = await fetch(`${API_ROOT}/api/feeds/${feedKey}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ value })
      });
      if (!res.ok) throw new Error("Yazma hatası");
      return await res.json();
    }

    async function init() {
      FEEDS.forEach(feed => grid.appendChild(cardTemplate(feed)));

      await Promise.allSettled(
        FEEDS.map(async feed => {
          const id = feed.key;
          try {
            setCardStatus(id, "Çekiliyor…");
            const v = await fetchLastValue(id);
            state[id].value = v;
            state[id].lastUpdated = `Son okuma: ${nowTR()}`;
            renderValue(id);
            setCardStatus(id, "Hazır");
          } catch {
            setCardStatus(id, "Hata");
            setGlobalStatus("Backend'e ulaşılamıyor", true);
          }
        })
      );
    }

    async function changeValue(feedKey, delta) {
      const id = feedKey;
      try {
        const next = state[id].value + delta;
        state[id].value = next;
        state[id].lastUpdated = `Yerel: ${nowTR()}`;
        renderValue(id);

        await pushValue(id, next);
        state[id].lastUpdated = `Kaydedildi: ${nowTR()}`;
        renderValue(id);
      } catch {
        setGlobalStatus("Yazma hatası", true);
      }
    }

    init();
  </script>
</body>
</html>
