<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kaza Namazı Sayacı</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 18px 16px; background: #111; color: #fff; }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }
    main { max-width: 720px; margin: 0 auto; padding: 14px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card {
      background: #fff; border-radius: 14px; padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .title { font-size: 16px; font-weight: 750; margin: 0; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    button {
      appearance: none; border: 0; border-radius: 12px; padding: 12px 10px;
      font-weight: 750; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.10);
    }
    .inc { background: #2f7dff; color: #fff; }
    .dec { background: #e9eefc; color: #111; }
    .valueBox {
      margin-top: 10px; display: flex; justify-content: center; align-items: center;
      padding: 12px; border-radius: 12px; background: #f2f4f8;
      font-size: 28px; font-weight: 900; letter-spacing: .5px;
    }
    .meta { margin-top: 8px; font-size: 12px; opacity: .75; display: flex; justify-content: space-between; }
    .status { font-size: 12px; opacity: .85; }
    .warn { color: #b00020; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Kaza Namazı Sayacı </h1>
  </header>

  <main>
    <div class="grid" id="grid"></div>
    <p class="status" id="globalStatus"></p>
  </main>

  <script>
    // === Adafruit IO Ayarları ===
    const ADAFRUIT_AIO_USERNAME = "serhaterdgn1";
    const ADAFRUIT_AIO_KEY = "aio_KgNt56ZYraYyRI2SxagklYkxDg4S"; // <-- Burayı kendi key’inle değiştir (paylaşma!)

    // Feed anahtarları (senin söylediğin isimlerle)
    const FEEDS = [
      { key: "sabah", label: "Sabah Namazı" },
      { key: "oglen",  label: "Öğle Namazı" },
      { key: "ikindi",label: "İkindi Namazı" },
      { key: "aksam", label: "Akşam Namazı" },
      { key: "yatsi", label: "Yatsı Namazı" }, // sen "yatkı" yazdın; feed anahtarı genelde ASCII olur: "yatki"
    ];

    // Eğer feed adın gerçekten "yatkı" ise (ı harfiyle),
    // yukarıdaki key'i "yatkı" yapman gerekir. URL encoding ile çalışabilir ama bazen sorun çıkar.

    const API_BASE = `https://io.adafruit.com/api/v2/${encodeURIComponent(ADAFRUIT_AIO_USERNAME)}/feeds`;

    const grid = document.getElementById("grid");
    const globalStatus = document.getElementById("globalStatus");

    // Yerel bellek (UI anlık hızlı dursun diye)
    const state = Object.fromEntries(FEEDS.map(f => [f.key, { value: 0, lastUpdated: "-" }]));

    function setGlobalStatus(msg, isWarn=false) {
      globalStatus.textContent = msg || "";
      globalStatus.className = "status" + (isWarn ? " warn" : "");
    }

    function cardTemplate(feed) {
      const id = feed.key;
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="row">
          <p class="title">${feed.label}</p>
          <span class="status" id="status-${id}">Yükleniyor…</span>
        </div>

        <div class="controls">
          <button class="inc" id="inc-${id}">Arttır</button>
          <button class="dec" id="dec-${id}">Azalt</button>
        </div>

        <div class="valueBox" id="val-${id}">0</div>

        <div class="meta">
          <span>Feed: <b>${feed.key}</b></span>
          <span id="upd-${id}">-</span>
        </div>
      `;
      return card;
    }

    function setCardStatus(id, msg) {
      const el = document.getElementById(`status-${id}`);
      if (el) el.textContent = msg;
    }

    function renderValue(id) {
      document.getElementById(`val-${id}`).textContent = String(state[id].value);
      document.getElementById(`upd-${id}`).textContent = state[id].lastUpdated || "-";
    }

    async function fetchLastValue(feedKey) {
      // Adafruit IO: feed bilgisi + last_value
      const url = `${API_BASE}/${encodeURIComponent(feedKey)}`;
      const res = await fetch(url, {
        headers: { "X-AIO-Key": ADAFRUIT_AIO_KEY }
      });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`GET ${feedKey} başarısız: ${res.status} ${t}`);
      }
      const data = await res.json();
      // data.last_value string olabilir
      const v = parseInt(data.last_value ?? "0", 10);
      return Number.isFinite(v) ? v : 0;
    }

    async function pushValue(feedKey, value) {
      // Adafruit IO: feed'e data ekle
      const url = `${API_BASE}/${encodeURIComponent(feedKey)}/data`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-AIO-Key": ADAFRUIT_AIO_KEY
        },
        body: JSON.stringify({ value: String(value) })
      });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`POST ${feedKey} başarısız: ${res.status} ${t}`);
      }
      return await res.json();
    }

    function nowTR() {
      // Tarayıcı yerel saatine göre string
      const d = new Date();
      return d.toLocaleString("tr-TR", { hour12: false });
    }

    async function init() {
      // UI kartları oluştur
      FEEDS.forEach(feed => {
        grid.appendChild(cardTemplate(feed));
      });

      // Key kontrol
      if (!ADAFRUIT_AIO_KEY || ADAFRUIT_AIO_KEY === "AIO_KEY_HERE") {
        setGlobalStatus("API key eklenmemiş: ADAFRUIT_AIO_KEY alanını doldur.", true);
      }

      // Butonlar
      FEEDS.forEach(feed => {
        const id = feed.key;

        document.getElementById(`inc-${id}`).addEventListener("click", async () => {
          await changeValue(id, +1);
        });

        document.getElementById(`dec-${id}`).addEventListener("click", async () => {
          await changeValue(id, -1);
        });
      });

      // İlk değerleri çek
      await Promise.allSettled(
        FEEDS.map(async (feed) => {
          const id = feed.key;
          try {
            setCardStatus(id, "Çekiliyor…");
            const v = await fetchLastValue(id);
            state[id].value = v;
            state[id].lastUpdated = `Son okuma: ${nowTR()}`;
            renderValue(id);
            setCardStatus(id, "Hazır");
          } catch (e) {
            console.error(e);
            setCardStatus(id, "Okuma hatası");
          }
        })
      );

      setGlobalStatus("Hazır.");
    }

    async function changeValue(feedKey, delta) {
      const id = feedKey;
      try {
        setCardStatus(id, "Gönderiliyor…");

        // Negatif olmasın istersen: aşağıdaki satırı aç
        // const next = Math.max(0, state[id].value + delta);

        const next = state[id].value + delta;
        // UI hemen güncelle (optimistic)
        state[id].value = next;
        state[id].lastUpdated = `Yerel: ${nowTR()}`;
        renderValue(id);

        // Sunucuya yaz
        await pushValue(id, next);

        state[id].lastUpdated = `Kaydedildi: ${nowTR()}`;
        renderValue(id);
        setCardStatus(id, "Hazır");
      } catch (e) {
        console.error(e);
        setCardStatus(id, "Yazma hatası");
        setGlobalStatus("Bir feed'e yazarken hata oluştu. Console'u kontrol et.", true);
      }
    }

    init();
  </script>
</body>
</html>
